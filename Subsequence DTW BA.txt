## Invaluable sources include the DTW documentation and vignette by Toni Giorgino and succesful application of DTW for core correlation by Trauth et al. (2018; https://bit.ly/2lmBytU). ##

setwd("E:/R (BA)")
library("dtw")
Ti9B <- read.csv("9BTest.csv")
Ti10A <- read.csv("10AonlyTest.csv")
Full10Ti <- read.csv("Full10Test.csv")

## TiD represents Ti normalised but multiplied by 10000 to easier visualise
## open.end and open.begin = TRUE enables 'subsequence matching' which discovers 
## the contiguous part of the template which best matches the whole query. 
## see DTW Vigenette for more great info!

## First run through plenty of kinks to iron out! ##

alignmentOBE <- dtw(Ti10A$TiD, Ti9B$TiD, 
                    keep=TRUE,step=asymmetric, 
                    open.end=TRUE,
                    open.begin=TRUE)

## Plot both curves - reference then query below

plot(alignmentOBE,type="two",off=3500);

## Triple plot to see both plots easier with the links between 

hq <- (0:200)/15
hq <- round(hq*1000)      #  indices in query for  pi/4 .. 7/4 pi
hw <- (alignmentOBE$index1 %in% hq)   # where are they on the w. curve?
hi <- (1:length(alignmentOBE$index1))[hw];   # get the indices of TRUE elems
dtwPlotThreeWay(alignmentOBE,
                match.indices=hi, 
                ylab="9B (base of composite)\n", xlab="\n10A (missing section #1)", 
                margin = 3.75, inner.margin = 0.44, 
                main = "Ti cps: 9B vs. 10A")

str(alignmentOBE)

## $ jmin = last index value of reference curve matched to query

## Tests with simple dummy data (comparing constant slope query with      
## slope-plateau-slope  reference) suggests horizontal lines indicate 
## no matching found within that section?

___________________________________________________________________________________________________


## Basic concept only! ## Full 10 plot - working on linking then to floating below (section 11)

alignment2 <- dtw(Full10Ti$TiD, Ti9B$TiD, keep=TRUE,step=asymmetric, open.end=TRUE,open.begin=TRUE)
plot(alignment2,type="two",off=4000);


hq <- (0:200)/10
hq <- round(hq*1000)      #  indices in query for  pi/4 .. 7/4 pi
hw <- (alignment2$index1 %in% hq)   # where are they on the w. curve?
hi <- (1:length(alignment2$index1))[hw];   # get the indices of TRUE elems
dtwPlotThreeWay(alignment2,match.indices=hi)
